<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>一起 - 魔兽世界公会</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- 头部 -->
  <header class="guild-header">
    <h1 class="guild-title">一起公会</h1>
    <p class="guild-motto">打本 休闲 洗脚</p>
  </header>
  <div class="background"></div>

  <main>
    <section class="content-card">
        <h2>近期团队活动报告</h2>
        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i> 正在加载WCL数据...
        </div>
        <div id="error" class="error" style="display: none;"></div>
        <table id="wcl-table" class="wcl-table" style="display: none;">
            <thead>
                <tr>
                    <th>日期</th>
                    <th>副本</th>
                    <th>进度</th>
                    <th>团长</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                <!-- 这里将通过JavaScript动态填充WCL数据 -->
            </tbody>
        </table>
    </section>
</main>

<script>
    // WCL API配置
    const WCL_CONFIG = {
        clientId: '9e8290c3-5586-4d3e-940e-110f8a83e337', // 替换为你的实际客户端ID
        clientSecret: 'JcZC8atgZ2GSa2qKBMsn2JLXE4slWRY49me9rR0S', // 替换为你的实际客户端密钥
        apiUri: 'https://www.warcraftlogs.com/api/v2/client',
        guildName: '一起公会', // 替换为你的公会名称
        serverName: '阿尔萨斯', // 如"暗影之月"
        serverRegion: 'CN' // 如"CN"
    };

    // 获取访问令牌
    async function getAccessToken() {
        try {
            const response = await fetch('https://www.warcraftlogs.com/oauth/token', {
                method: 'POST',
                headers: {
                    'Authorization': 'Basic ' + btoa(`${WCL_CONFIG.clientId}:${WCL_CONFIG.clientSecret}`),
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'grant_type=client_credentials'
            });
            
            const data = await response.json();
            return data.access_token;
        } catch (error) {
            console.error('获取访问令牌失败:', error);
            throw error;
        }
    }

    // 获取公会数据
    async function fetchGuildReports(accessToken) {
        try {
            // GraphQL查询 - 获取公会报告
            const query = `
                query {
                    guildData {
                        guild(name: "${WCL_CONFIG.guildName}", serverSlug: "${WCL_CONFIG.serverName}", serverRegion: "${WCL_CONFIG.serverRegion}") {
                            name
                            server {
                                name
                                region {
                                    slug
                                }
                            }
                            attendance {
                                startTime
                                zone {
                                    name
                                }
                                total
                                logs {
                                    startTime
                                    endTime
                                    code
                                    owner
                                    fights {
                                        encounterID
                                        name
                                        kill
                                        size
                                    }
                                }
                            }
                        }
                    }
                }
            `;
            
            const response = await fetch(WCL_CONFIG.apiUri, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({ query })
            });
            
            return await response.json();
        } catch (error) {
            console.error('获取公会数据失败:', error);
            throw error;
        }
    }

    // 显示WCL数据
    function displayWclData(guildData) {
        const loadingElement = document.getElementById('loading');
        const tableElement = document.getElementById('wcl-table');
        const tbody = tableElement.querySelector('tbody');
        
        loadingElement.style.display = 'none';
        tableElement.style.display = 'table';
        
        // 清空现有数据
        tbody.innerHTML = '';
        
        // 检查是否有数据
        if (!guildData || !guildData.data || !guildData.data.guildData || !guildData.data.guildData.guild) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="5" style="text-align: center;">没有找到团队活动记录</td>';
            tbody.appendChild(row);
            return;
        }
        
        const guild = guildData.data.guildData.guild;
        
        // 添加新数据
        if (guild.attendance && guild.attendance.logs) {
            guild.attendance.logs.forEach(log => {
                const row = document.createElement('tr');
                
                // 计算进度
                const kills = log.fights.filter(fight => fight.kill).length;
                const totalEncounters = new Set(log.fights.map(fight => fight.encounterID)).size;
                const progress = `${kills}/${totalEncounters}`;
                
                // 格式化日期
                const date = new Date(log.startTime);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${log.zone.name}</td>
                    <td>${progress}</td>
                    <td>${log.owner}</td>
                    <td><a href="https://www.warcraftlogs.com/reports/${log.code}" target="_blank" class="wcl-button">查看报告</a></td>
                `;
                tbody.appendChild(row);
            });
        } else {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="5" style="text-align: center;">没有找到团队活动记录</td>';
            tbody.appendChild(row);
        }
    }

    // 显示错误信息
    function showError(message) {
        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('error');
        
        loadingElement.style.display = 'none';
        errorElement.textContent = message;
        errorElement.style.display = 'block';
    }

    // 页面加载时获取并显示数据
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            // 1. 获取访问令牌
            const accessToken = await getAccessToken();
            
            // 2. 获取公会数据
            const guildData = await fetchGuildReports(accessToken);
            
            // 3. 显示数据
            displayWclData(guildData);
        } catch (error) {
            showError(`加载数据失败: ${error.message}`);
            console.error(error);
        }
    });
</script>

  
</body>
</html>