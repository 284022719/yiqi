<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸€èµ· - é­”å…½ä¸–ç•Œå…¬ä¼š</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- å¤´éƒ¨ -->
  <header class="guild-header">
    <h1 class="guild-title">ä¸€èµ·å…¬ä¼š</h1>
    <p class="guild-motto">æ‰“æœ¬ ä¼‘é—² æ´—è„š</p>
  </header>
  <div class="background"></div>

  <!-- ä¸»å†…å®¹åŒº -->
  <main>
    <!-- WCLæˆ˜æ–—æ•°æ® -->
    <div class="content-card wcl-reports">
      <h2>ğŸ“Š æœ€æ–°æˆ˜æ–—æŠ¥å‘Š</h2>
      <div class="loading">æ•°æ®åŠ è½½ä¸­...</div>
      <table class="dkp-table" id="wcl-table">
        <thead>
          <tr>
            <th>æ—¥æœŸ</th>
            <th>å‰¯æœ¬</th>
            <th>è¿›åº¦</th>
            <th>æ—¶é•¿</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- åŸæœ‰å…¶ä»–å†…å®¹ä¿æŒä¸å˜... -->
  </main>

  <script>
    // WCLé…ç½®
    const WCL_CLIENT_ID = '9e814e47-00ba-4e13-a7b7-c5153ec3bdc0';
    const WCL_CLIENT_SECRET = '-'; // æ³¨æ„ï¼šå‰ç«¯æš´éœ²secretå­˜åœ¨é£é™©
    const GUILD_ID = 'æ›¿æ¢ä¸ºä½ çš„å…¬ä¼šID'; 

    // è·å–è®¿é—®ä»¤ç‰Œ
    async function getWCLLogin() {
      const authUrl = `https://www.warcraftlogs.com/oauth/authorize?
        response_type=code&
        client_id=${WCL_CLIENT_ID}&
        redirect_uri=${encodeURIComponent(window.location.href)}`;
      
      window.location.href = authUrl;
    }

    // è·å–æˆ˜æ–—æŠ¥å‘Š
    async function fetchWCLReports() {
      try {
        // 1. è·å–è®¿é—®ä»¤ç‰Œ
        const tokenResponse = await fetch('https://www.warcraftlogs.com/oauth/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Authorization': `Basic ${btoa(WCL_CLIENT_ID + ':' + WCL_CLIENT_SECRET)}`
          },
          body: 'grant_type=client_credentials'
        });

        const { access_token } = await tokenResponse.json();

        // 2. è·å–å…¬ä¼šæŠ¥å‘Š
        const reportsResponse = await fetch(
          `https://cn.warcraftlogs.com/v1/reports/guild/${GUILD_ID}?api_key=${access_token}`
        );
        
        const reports = await reportsResponse.json();
        renderReports(reports);

      } catch (error) {
        console.error('WCLæ•°æ®è·å–å¤±è´¥:', error);
        document.querySelector('.loading').textContent = 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•';
      }
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderReports(reports) {
      const tbody = document.querySelector('#wcl-table tbody');
      tbody.innerHTML = '';

      reports.forEach(report => {
        const row = `
          <tr>
            <td>${new Date(report.start).toLocaleDateString()}</td>
            <td>${report.zone.name}</td>
            <td>${report.fights.filter(f => f.kill).length}/${report.fights.length}</td>
            <td>${Math.floor(report.end - report.start)/60}åˆ†é’Ÿ</td>
          </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
      });

      document.querySelector('.loading').style.display = 'none';
    }

    // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
    window.addEventListener('DOMContentLoaded', fetchWCLReports);
  </script>
</body>
</html>
