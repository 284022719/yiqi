<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>一起 - 魔兽世界公会</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- 头部 -->
  <header class="guild-header">
    <h1 class="guild-title">一起公会</h1>
    <p class="guild-motto">打本 休闲 洗脚</p>
  </header>
  <div class="background"></div>

      <main>
        <section class="content-card">
            <h2>近期团队活动报告</h2>
            <div id="loading" class="loading">
                <i class="fas fa-spinner fa-spin"></i> 正在加载WCL数据...
            </div>
            <div id="error" class="error" style="display: none;"></div>
            <table id="wcl-table" class="wcl-table" style="display: none;">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>副本</th>
                        <th>进度</th>
                        <th>团长</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </main>

    <script>
        // 获取WCL数据
        async function fetchGuildReports() {
            try {
                const apiUrl = `/.netlify/functions/wcl-proxy`;
                console.log('Fetching guild data from:', apiUrl);
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `请求失败 (${response.status})`);
                }
                
                const data = await response.json();
                console.log('API响应数据:', data);
                
                if (!data?.data?.guild) {
                    throw new Error('API返回数据格式不正确');
                }
                
                return data;
            } catch (error) {
                console.error('获取数据失败:', error);
                throw new Error(`获取公会数据失败: ${error.message}`);
            }
        }

        // 显示WCL数据
        function displayWclData(data) {
            const guildData = data.data.guild;
            console.log('处理公会数据:', guildData);
            
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error');
            const tableElement = document.getElementById('wcl-table');
            const tbody = tableElement.querySelector('tbody');
            
            loadingElement.style.display = 'none';
            errorElement.style.display = 'none';
            
            if (!guildData.attendance?.logs?.length) {
                errorElement.textContent = `没有找到近期活动记录 (最后查询: ${new Date().toLocaleString()})`;
                errorElement.style.display = 'block';
                return;
            }
            
            tableElement.style.display = 'table';
            tbody.innerHTML = '';
            
            guildData.attendance.logs.forEach(log => {
                const row = document.createElement('tr');
                
                // 计算进度
                const kills = log.fights?.filter(fight => fight.kill).length || 0;
                const totalEncounters = new Set(log.fights?.map(fight => fight.encounterID) || []).size;
                const progress = totalEncounters > 0 ? `${kills}/${totalEncounters}` : '无数据';
                
                // 格式化日期
                const date = new Date(log.startTime);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${log.zone?.name || '未知副本'}</td>
                    <td>${progress}</td>
                    <td>${log.owner || '未知团长'}</td>
                    <td><a href="https://www.warcraftlogs.com/reports/${log.code}" target="_blank" class="wcl-button">查看报告</a></td>
                `;
                tbody.appendChild(row);
            });
        }

        // 页面加载时获取并显示数据
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const data = await fetchGuildReports();
                displayWclData(data);
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').textContent = error.message;
                document.getElementById('error').style.display = 'block';
                console.error('页面加载错误:', error);
            }
        });
    </script>

  
</body>
</html>
